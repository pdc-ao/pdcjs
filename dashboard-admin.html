<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard — Administração</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<div class="sidebar">
  <!-- same sidebar links -->
</div>

<div class="main">
  <h1>Administração</h1>
  <p id="userInfo">Carregando sessão...</p>

  <div class="card">
    <h2>Usuários Pendentes</h2>
    <table>
      <thead>
        <tr><th>Email</th><th>Função</th><th>Status</th><th>Ações</th></tr>
      </thead>
      <tbody id="userTableBody"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Documentos para Revisão</h2>
    <table>
      <thead>
        <tr><th>Usuário</th><th>Tipo</th><th>Status</th><th>Ações</th></tr>
      </thead>
      <tbody id="documentTableBody"></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Pagamentos Recentes</h2>
    <table>
      <thead>
        <tr><th>De</th><th>Para</th><th>Valor</th><th>Status</th></tr>
      </thead>
      <tbody id="paymentTableBody"></tbody>
    </table>
  </div>
</div>

<script type="module">
  import {
    getSession,
    logout,
    getData,
    updateItem,
    renderUserInfo
  } from './js/dashboard.js';

  const user = getSession();
  renderUserInfo('#userInfo');

  document.getElementById('logoutBtn').addEventListener('click', e => {
    e.preventDefault();
    logout();
  });

  const usersKey = 'agri_users_demo';
  const documentsKey = 'agri_documents_demo';
  const paymentsKey = 'agri_payments_demo';

  const userTableBody = document.getElementById('userTableBody');
  const documentTableBody = document.getElementById('documentTableBody');
  const paymentTableBody = document.getElementById('paymentTableBody');

  function renderUsers() {
    const users = getData(usersKey);
    userTableBody.innerHTML = '';
    users.filter(u => u.verificationStatus === 'Pendente').forEach(u => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${u.email}</td>
        <td>${u.role}</td>
        <td>${u.verificationStatus}</td>
        <td>
          <button onclick="verifyUser('${u.email}')">Aprovar</button>
          <button onclick="rejectUser('${u.email}')">Rejeitar</button>
        </td>
      `;
      userTableBody.appendChild(row);
    });
  }

  function verifyUser(email) {
    updateItem(usersKey, email, { verificationStatus: 'Verificado' });
    renderUsers();
  }

  function rejectUser(email) {
    updateItem(usersKey, email, { verificationStatus: 'Rejeitado' });
    renderUsers();
  }

  function renderDocuments() {
    const docs = getData(documentsKey);
    documentTableBody.innerHTML = '';
    docs.filter(d => d.status === 'Pendente').forEach(d => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${d.userId}</td>
        <td>${d.type}</td>
        <td>${d.status}</td>
        <td>
          <button onclick="approveDoc('${d.id}')">Aprovar</button>
          <button onclick="rejectDoc('${d.id}')">Rejeitar</button>
        </td>
      `;
      documentTableBody.appendChild(row);
    });
  }

  function approveDoc(id) {
    updateItem(documentsKey, id, { status: 'Aprovado' });
    renderDocuments();
  }

  function rejectDoc(id) {
    updateItem(documentsKey, id, { status: 'Rejeitado' });
    renderDocuments();
  }

  function renderPayments() {
    const txns = getData(paymentsKey);
    paymentTableBody.innerHTML = '';
    txns.forEach(t => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${t.sender}</td>
        <td>${t.receiver}</td>
        <td>AOA ${t.amount.toFixed(2)}</td>
        <td>${t.status}</td>
      `;
      paymentTableBody.appendChild(row);
    });
  }

  renderUsers();
  renderDocuments();
  renderPayments();
</script>
</body>
</html>
