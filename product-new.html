<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Novo Produto — AgriConnect</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<header class="site-header"><div class="container header-inner"><a class="brand" href="index.html"><span class="logo">A</span><span class="brand-name">AgriConnect</span></a></div></header>

<main class="container">
  <h1>Criar nova listagem</h1>
  <div id="msg" class="muted"></div>
  <form id="productForm" class="auth-page" style="max-width:700px">
    <label>Título<input name="title" required /></label>
    <label>Descrição<textarea name="description" rows="4"></textarea></label>
    <label>Categoria<input name="category" required /></label>
    <label>Quantidade disponível<input name="quantityAvailable" type="number" step="any" required /></label>
    <label>Unidade (kg, sacos, etc.)<input name="unitOfMeasure" required /></label>
    <label>Preço por unidade<input name="pricePerUnit" type="number" step="any" required /></label>
    <label>Moeda<input name="currency" value="AOA" /></label>
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Criar</button>
    </div>
  </form>
</main>

<footer class="site-footer"><div class="container">© <span id="yearPN"></span> AgriConnect Angola</div></footer>

<script src="app.js"></script>
<script>
  document.getElementById('yearPN').innerText = new Date().getFullYear();

  document.getElementById('productForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const f = Object.fromEntries(new FormData(e.target));
    const msg = document.getElementById('msg');
    msg.textContent = '';

    // Demo mode: if no server session, store locally; otherwise POST to /api/products
    const user = getDemoSession();
    if (!user) {
      // demo: localStorage store
      const key = 'agri_demo_products';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      const p = { id: 'demo-'+Date.now(), ...f, producerId: 'demo-user' };
      arr.unshift(p);
      localStorage.setItem(key, JSON.stringify(arr));
      alert('Produto criado (modo demo).');
      return;
    }

    try {
      const res = await fetch('/api/products', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(f),
      });
      const json = await res.json();
      if (!res.ok) throw new Error(json?.error || 'Falha ao criar produto');
      alert('Produto criado com sucesso.');
      location.href = 'dashboard-products.html';
    } catch (err) {
      msg.textContent = 'Erro: ' + err.message;
    }
  });
</script>
</body>
</html>
