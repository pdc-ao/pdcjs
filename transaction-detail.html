<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detalhe da Transa√ß√£o ‚Äî AgriConnect</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .sidebar { width: 220px; background: #fff; border-right: 1px solid var(--border); position: fixed; top:0; bottom:0; left:0; padding:20px; }
    .sidebar a { display:block; padding:8px; margin-bottom:6px; color:var(--muted); text-decoration:none; border-radius:6px; }
    .sidebar a.active, .sidebar a:hover { background: var(--accent); color:#fff; }
    .main { margin-left:240px; padding:20px; }
    .detail-card { max-width: 700px; margin: 1rem auto; padding: 1rem; border: 1px solid var(--border); border-radius: 6px; background: #fff; }
    .detail-card h2 { margin-top: 0; }
    .detail-row { margin-bottom: 0.5rem; }
    .label { font-weight: bold; display: inline-block; width: 150px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.5rem; border-bottom: 1px solid #ddd; }
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: bold;
      color: #fff;
    }
    .status-PENDING { background: #6c757d; }
    .status-FUNDED { background: #007bff; }
    .status-SELLER_CONFIRMED { background: #17a2b8; }
    .status-BUYER_CONFIRMED { background: #28a745; }
    .status-RELEASED { background: #20c997; }
    .status-DISPUTED { background: #ffc107; color: #000; }
    .status-REFUNDED { background: #fd7e14; }
    .status-CANCELLED { background: #dc3545; }
    .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px; }
    .btn-success { background: #28a745; color: #fff; }
    .btn-warning { background: #ffc107; color: #000; }
    .muted { color: var(--muted); font-style: italic; margin-top: 0.5rem; }
  </style>
</head>
<body>
<div class="sidebar">
  <h2>AgriConnect</h2>
  <a href="dashboard.html">üìä Dashboard</a>
  <a href="dashboard-wallet.html" class="active">üí≥ Pagamentos</a>
  <a href="auth.html" id="logoutBtn">üö™ Sair</a>
</div>

<div class="main">
  <h1>Detalhe da Transa√ß√£o</h1>
  <p id="userInfo">Carregando sess√£o...</p>

  <div class="detail-card" id="txnDetail">Carregando detalhes da transa√ß√£o...</div>

  <div class="detail-card">
    <h3>Hist√≥rico de A√ß√µes</h3>
    <table>
      <thead>
        <tr><th>Data</th><th>A√ß√£o</th><th>Ator</th><th>Notas</th></tr>
      </thead>
      <tbody id="eventLog">
        <tr><td colspan="4">Carregando...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="detail-card" id="adminActions" style="display:none;">
    <h3>A√ß√µes Administrativas</h3>
    <button id="releaseBtn" class="btn btn-success">Liberar Pagamento</button>
    <button id="refundBtn" class="btn btn-warning">Reembolsar</button>
    <div id="adminMsg" class="muted"></div>
  </div>
</div>

<footer class="site-footer">
  <div class="container">¬© <span id="yearTD"></span> AgriConnect Angola</div>
</footer>

<script src="js/app.js"></script>
<script type="module">
  import { getSession, logout, renderUserInfo } from './js/dashboard.js';

  document.getElementById('yearTD').innerText = new Date().getFullYear();

  const user = getSession();
  const token = localStorage.getItem('pdc_auth_token');
  renderUserInfo('#userInfo');
  document.getElementById('logoutBtn').addEventListener('click', e => { e.preventDefault(); logout(); });

  const txnId = new URLSearchParams(location.search).get('id');
  const statusLabels = {
    PENDING: 'Pendente',
    FUNDED: 'Financiado',
    SELLER_CONFIRMED: 'Confirmado pelo Vendedor',
    BUYER_CONFIRMED: 'Confirmado pelo Comprador',
    RELEASED: 'Liberado',
    DISPUTED: 'Em Disputa',
    REFUNDED: 'Reembolsado',
    CANCELLED: 'Cancelado'
  };
  const statusTips = {
    PENDING: 'Aguardando financiamento do comprador.',
    FUNDED: 'Pagamento em cust√≥dia.',
    SELLER_CONFIRMED: 'Vendedor confirmou a entrega.',
    BUYER_CONFIRMED: 'Comprador confirmou o recebimento.',
    RELEASED: 'Pagamento liberado ao vendedor.',
    DISPUTED: 'Transa√ß√£o contestada por uma das partes.',
    REFUNDED: 'Valor devolvido ao comprador.',
    CANCELLED: 'Transa√ß√£o cancelada antes do pagamento.'
  };

  async function loadTransaction() {
    const container = document.getElementById('txnDetail');
    try {
      const res = await fetch(`/api/payments/transactions/${txnId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error('Erro ao carregar detalhes');
      const t = await res.json();
      const badge = `<span class="status-badge status-${t.status}" title="${statusTips[t.status] || ''}">${statusLabels[t.status] || t.status}</span>`;
      container.innerHTML = `
        <h2>Transa√ß√£o ${t.id}</h2>
        <div class="detail-row"><span class="label">Valor:</span> AOA ${Number(t.amount).toFixed(2)}</div>
        <div class="detail-row"><span class="label">Status:</span> ${badge}</div>
        <div class="detail-row"><span class="label">Comprador:</span> ${t.buyer?.fullName || t.buyer?.username || t.buyerId}</div>
        <div class="detail-row"><span class="label">Vendedor:</span> ${t.seller?.fullName || t.seller?.username || t.sellerId}</div>
        <div class="detail-row"><span class="label">Descri√ß√£o:</span> ${t.description || '-'}</div>
        <div class="detail-row"><span class="label">Criado em:</span> ${new Date(t.createdAt).toLocaleString()}</div>
        ${t.releasedAt ? `<div class="detail-row"><span class="label">Finalizado em:</span> ${new Date(t.releasedAt).toLocaleString()}</div>` : ''}
      `;

      const adminBox = document.getElementById('adminActions');
      const releaseBtn = document.getElementById('releaseBtn');
      const refundBtn = document.getElementById('refundBtn');
      if (user.role === 'ADMIN' && ['BUYER_CONFIRMED', 'SELLER_CONFIRMED', 'DISPUTED'].includes(t.status)) {
        adminBox.style.display = 'block';
        releaseBtn.style.display = ['BUYER_CONFIRMED', 'SELLER_CONFIRMED'].includes(t.status) ? 'inline-block' : 'none';
        refundBtn.style.display = t.status === 'DISPUTED' ? 'inline-block' : 'none';
      }
    } catch (err) {
      container.textContent = '‚ùå Erro: ' + err.message;
    }
  }

  async function loadEvents() {
    const tbody = document.getElementById('eventLog');
    try {
      const res = await fetch(`/api/payments/transactions/${txnId}/events`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error('Erro ao carregar eventos');
      const events = await res.json();
      tbody.innerHTML = '';
      if (!events.length) {
        tbody.innerHTML = '<tr><td colspan="4">Nenhum evento registrado.</td></tr>';
        return;
      }
      events.forEach(ev => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${new Date(ev.timestamp).toLocaleString()}</td>
          <td>${ev.action}</td>
          <td>${ev.actor?.fullName || ev.actor?.username || ev.actorId}</td>
          <td>${ev.notes || ''}</td>
        `;
        tbody.appendChild(row);
      });
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="4">‚ùå Erro: ${err.message}</td></tr>`;
    }
  }

  async function adminAct(action) {
    if (!confirm(`Executar a√ß√£o administrativa: ${action}?`)) return;
    const adminMsg = document.getElementById('adminMsg');
    try {
      const res = await fetch(`/api/payments/transactions/${txnId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ action })
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || 'Falha');
      }
      adminMsg.textContent = `‚úÖ A√ß√£o ${action} executada com sucesso.`;
      await loadTransaction();
      await loadEvents();
    } catch (err) {
      adminMsg.textContent = `‚ùå Erro: ${err.message}`;
    }
  }

  document.getElementById('releaseBtn').onclick = () => adminAct('RELEASE');
  document.getElementById('refundBtn').onclick = () => adminAct('REFUND');

  loadTransaction();
  loadEvents();
</script>
</body>
</html>
