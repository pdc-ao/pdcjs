<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard â€” NotificaÃ§Ãµes</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .sidebar { width: 220px; background: #fff; border-right: 1px solid var(--border); position: fixed; top:0; bottom:0; left:0; padding:20px; }
    .sidebar a { display:block; padding:8px; margin-bottom:6px; color:var(--muted); text-decoration:none; border-radius:6px; }
    .sidebar a.active, .sidebar a:hover { background: var(--accent); color:#fff; }
    .main { margin-left:240px; padding:20px; }
    .card { background:#fff; border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px; }
    #notificationList { list-style: none; padding-left: 0; margin: 0; }
    #notificationList li { padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; background: #fff; }
    #notificationList li .time { color: var(--muted); font-size: 14px; margin-left: 8px; }
    .prefs-grid label { display: inline-flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .btn { margin-top: 8px; }
  </style>
</head>
<body>
<div class="sidebar">
  <h2>AgriConnect</h2>
  <a href="dashboard.html">ğŸ“Š Dashboard</a>
  <a href="dashboard-products.html">ğŸ“¦ Produtos</a>
  <a href="dashboard-orders.html">ğŸ›’ Pedidos</a>
  <a href="dashboard-storage.html">ğŸ­ Armazenamento</a>
  <a href="dashboard-transport.html">ğŸšš Transporte</a>
  <a href="dashboard-transformation.html">âš™ï¸ TransformaÃ§Ã£o</a>
  <a href="dashboard-messages.html">ğŸ’¬ Mensagens</a>
  <a href="dashboard-reviews.html">â­ AvaliaÃ§Ãµes</a>
  <a href="dashboard-wallet.html">ğŸ’³ Pagamentos</a>
  <a href="dashboard-notifications.html" class="active">ğŸ”” NotificaÃ§Ãµes</a>
  <a href="dashboard-admin.html">ğŸ› ï¸ Admin</a>
  <a href="dashboard-procurement.html">ğŸ“¥ Procurement</a>
  <a href="dashboard-offerings.html">ğŸ Ofertas</a>
  <a href="dashboard-facilities.html">ğŸ—ï¸ InstalaÃ§Ãµes</a>
  <a href="dashboard-production.html">ğŸ§ª ProduÃ§Ã£o</a>
  <a href="dashboard-consumer.html">ğŸ§â€â™‚ï¸ Consumidor</a>
  <a href="dashboard-producer.html">ğŸ§‘â€ğŸŒ¾ Produtor</a>
  <a href="dashboard-storage-owner.html">ğŸ“¦ ProprietÃ¡rio de ArmazÃ©m</a>
  <a href="auth.html" id="logoutBtn">ğŸšª Sair</a>
  <a href="upload-documents.html">ğŸ“‘ Enviar Documentos</a>
</div>

<div class="main">
  <h1>NotificaÃ§Ãµes</h1>
  <p id="userInfo">Carregando sessÃ£o...</p>

  <div class="card">
    <h2>Alertas Recentes</h2>
    <ul id="notificationList" role="list"></ul>
    <div id="notifMsg" class="muted"></div>
    <button id="markAllBtn" class="btn btn-sm">Marcar todas como lidas</button>
  </div>

  <div class="card">
    <h2>PreferÃªncias de NotificaÃ§Ã£o</h2>
    <form id="preferencesForm" class="prefs-grid">
      <fieldset>
        <legend>Escolha como deseja receber notificaÃ§Ãµes:</legend>
        <label><input type="checkbox" name="email" /> Receber por email</label><br/>
        <label><input type="checkbox" name="sms" /> Receber por SMS</label><br/>
        <label><input type="checkbox" name="app" /> NotificaÃ§Ãµes no aplicativo</label><br/>
      </fieldset>
      <button class="btn btn-primary" type="submit">Salvar PreferÃªncias</button>
    </form>
    <div id="prefsMsg" class="muted" style="margin-top:8px;"></div>
  </div>
</div>

<script type="module">
  import { getSession, logout, getData, setData, renderUserInfo } from './js/dashboard.js';

  const user = getSession();
  renderUserInfo('#userInfo');
  document.getElementById('logoutBtn').addEventListener('click', e => { e.preventDefault(); logout(); });

  const notificationsKey = 'pdc_notifications_demo';
  const preferencesKey = 'pdc_preferences_demo';

  const notificationList = document.getElementById('notificationList');
  const preferencesForm = document.getElementById('preferencesForm');
  const notifMsg = document.getElementById('notifMsg');
  const prefsMsg = document.getElementById('prefsMsg');
  const markAllBtn = document.getElementById('markAllBtn');

  function renderNotifications() {
    notificationList.innerHTML = '';
    if (!user) {
      notifMsg.textContent = 'FaÃ§a login para ver notificaÃ§Ãµes.';
      return;
    }
    const alerts = getData(notificationsKey) || [];
    const userAlerts = alerts.filter(n => n.userId === (user.email || user.id));
    if (!userAlerts.length) {
      notifMsg.textContent = 'Sem alertas recentes.';
      return;
    }
    notifMsg.textContent = '';
    userAlerts.forEach(n => {
      const li = document.createElement('li');
      li.setAttribute('role','listitem');
      const icon = n.icon || 'ğŸ””';
      const time = n.time ? new Date(n.time).toLocaleString('pt-AO') : '';
      li.innerHTML = `${icon} ${n.message}${time ? `<span class="time">â€¢ ${time}</span>` : ''}`;
      notificationList.appendChild(li);
    });
  }

  function loadPreferences() {
    if (!user) {
      prefsMsg.textContent = 'FaÃ§a login para ajustar preferÃªncias.';
      return;
    }
    const all = getData(preferencesKey) || [];
    const prefs = all.find(p => p.userId === (user.email || user.id));
    if (prefs) {
      preferencesForm.email.checked = !!prefs.email;
      preferencesForm.sms.checked = !!prefs.sms;
      preferencesForm.app.checked = !!prefs.app;
      prefsMsg.textContent = 'PreferÃªncias carregadas.';
    } else {
      prefsMsg.textContent = 'Sem preferÃªncias salvas.';
    }
  }

  preferencesForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!user) return;
    const btn = preferencesForm.querySelector('button[type="submit"]');
    btn.disabled = true;
    const oldText = btn.textContent;
    btn.textContent = 'Aguardeâ€¦';
    const prefs = {
      userId: user.email || user.id,
      email: preferencesForm.email.checked,
      sms: preferencesForm.sms.checked,
      app: preferencesForm.app.checked
    };
    const all = (getData(preferencesKey) || []).filter(p => p.userId !== (user.email || user.id));
    all.push(prefs);
    setData(preferencesKey, all);
    prefsMsg.textContent = 'âœ… PreferÃªncias salvas!';
    btn.disabled = false;
    btn.textContent = oldText;
  });

  markAllBtn.addEventListener('click', () => {
    if (!user) return;
    const alerts = (getData(notificationsKey) || []).map(n => {
      if (n.userId === (user.email || user.id)) return { ...n, read: true };
      return n;
    });
    setData(notificationsKey, alerts);
    notifMsg.textContent = 'Todas as notificaÃ§Ãµes foram marcadas como lidas.';
    renderNotifications();
  });

  renderNotifications();
  loadPreferences();
</script>
</body>
</html>