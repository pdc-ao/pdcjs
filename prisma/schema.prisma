generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PRISMA_DATABASE_URL")
  // shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

/**
 * =======================
 */
/**
 * ==== CORE ENUMS ========
 */
/**
 * =======================
 */

enum UserRole {
  PRODUCER
  CONSUMER
  STORAGE_OWNER
  TRANSPORTER
  TRANSFORMER
  ADMIN
}

enum EntityType {
  INDIVIDUAL
  COMPANY
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum DocumentStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

enum EscrowStatus {
  HELD
  RELEASED
  CANCELLED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

/**
 * ===========================
 */
/**
 * ==== PRODUCTION ENUMS ====
 */
/**
 * ===========================
 */

enum ProductionStatus {
  PLANNED
  IN_PREPARATION
  PLANTED
  GROWING
  READY_TO_HARVEST
  HARVESTING
  HARVESTED
  CANCELLED
}

enum MilestoneType {
  LAND_PREPARATION
  PLANTING
  FERTILIZATION
  IRRIGATION
  PEST_CONTROL
  WEEDING
  HARVEST_START
  HARVEST_COMPLETE
  POST_HARVEST
  CUSTOM
}

enum ScheduleStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  DELAYED
  SKIPPED
}

enum UpdateType {
  PROGRESS_UPDATE
  MILESTONE_REACHED
  ISSUE_REPORTED
  QUANTITY_CHANGE
  DATE_CHANGE
  WEATHER_IMPACT
  PEST_DISEASE
  GENERAL
}

enum PreOrderStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

/**
 * =============================
 */
/**
 * ==== ENRICHMENT ENUMS ======
 */
/**
 * =============================
 */

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationDeliveryStatus {
  QUEUED
  SENT
  FAILED
}

enum ShipmentStatus {
  PENDING_PICKUP
  IN_TRANSIT
  DELAYED
  DELIVERED
  CANCELLED
}

enum TrackingEventType {
  PICKED_UP
  ARRIVED_AT_HUB
  DEPARTED_HUB
  OUT_FOR_DELEVERY
  DELIVERED
  EXCEPTION
}

enum PromotionType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum RolePermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  MANAGE
}

enum SeverityLevel {
  INFO
  WARNING
  ERROR
  CRITICAL
}

/**
 * =====================
 */
/**
 * ==== MODELS ========
 */
/**
 * =====================
 */

model User {
  id           String @id @default(uuid())
  username     String @unique
  email        String @unique
  passwordHash String

  entityType EntityType @default(INDIVIDUAL)

  fullName    String?
  dateOfBirth DateTime?

  companyName        String?   @unique
  registrationNumber String?
  taxId              String?
  companyType        String?
  incorporationDate  DateTime?

  phoneNumber       String?
  addressLine1      String?
  addressLine2      String?
  city              String?
  stateProvince     String?
  postalCode        String?
  country           String  @default("Angola")
  latitude          Float?
  longitude         Float?
  profilePictureUrl String?

  role                UserRole           @default(CONSUMER)
  isVerified          Boolean            @default(false)
  verificationStatus  VerificationStatus @default(PENDING)
  verificationDetails String?
  averageRating       Float?

  notificationPreferences Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /**
   * ---- ROLE‑SPECIFIC DETAIL ----
   */
  producerDetails    ProducerDetails?    @relation("ProducerDetails")
  storageDetails     StorageDetails?     @relation("StorageDetails")
  transporterDetails TransporterDetails? @relation("TransporterDetails")

  /**
   * ---- LISTINGS / OFFERS ----
   */
  productListings          ProductListing[]         @relation("ProducerListings")
  storageListings          StorageListing[]         @relation("StorageListings")
  transportListings        TransportListing[]       @relation("TransportListings")
  transformationFacilities TransformationFacility[] @relation("OwnerFacilities")
  offerings                Offering[]

  /**
   * ---- ORDERS & TRANSACTIONS ----
   */
  buyerOrders        Order[]              @relation("BuyerOrders")
  sellerOrders       Order[]              @relation("SellerOrders")
  transporterOrders  Order[]              @relation("TransporterOrders")
  buyerTransactions  PaymentTransaction[] @relation("Buyer")
  sellerTransactions PaymentTransaction[] @relation("Seller")

  /**
   * ---- REVIEWS & RATINGS ----
   */
  reviewsGiven    Review[]     @relation("ReviewerReviews")
  reviewsReceived Review[]     @relation("ReviewedUserReviews")
  ratingsGiven    UserRating[] @relation("Reviewer")
  ratingsReceived UserRating[] @relation("Reviewed")

  /**
   * ---- MESSAGING ----
   */
  messagesSent             Message[]                 @relation("SenderMessages")
  messagesReceived         Message[]                 @relation("ReceiverMessages")
  conversationParticipants ConversationParticipant[] @relation("ParticipantConversations")

  /**
   * ---- DOCUMENTS & WALLET ----
   */
  documents         Document[]
  paymentReferences PaymentReference[]
  walletBalance     WalletBalance?
  transactionLedger TransactionLedger[]

  /**
   * ---- AUDIT & SCHEDULING ----
   */
  auditLogs         AuditLog[]
  offeringSchedules OfferingSchedule[]

  /**
   * ---- FACILITY BOOKINGS ----
   */
  facilityBookings FacilityBooking[]

  /**
   * ---- ORDER STATUS HISTORY ----
   */
  orderStatusChanges OrderStatusHistory[]

  /**
   * ---- NOTIFICATIONS ----
   */
  notifications               Notification[]
  notificationDeliveriesOwned NotificationDelivery[] @relation("UserNotificationDeliveries")

  /**
   * ---- PRODUCTION PLANNING ----
   */
  productionPlans         ProductionPlan[]       @relation("ProductionPlans")
  productionUpdates       ProductionUpdate[]
  productionSubscriptions ProductionSubscriber[]
  preOrders               PreOrder[]

  /**
   * ---- PROCUREMENT ----
   */
  componentsRequested Component[] @relation("RequestedComponents")

  /**
   * ---- SESSIONS ----
   */
  sessions Session[]

  /**
   * ---- CERTIFICATIONS ----
   */
  certifications Certification[]

  /**
   * ---- INVERSE RELATIONS (added for missing opposite sides) ----
   */
  // Shipments where this user acts as the transporter
  transportedShipments         Shipment[]            @relation("ShipmentTransporter")
  // Verification requests this user reviews
  verificationRequestsReviewed VerificationRequest[] @relation("UserVerificationRequests")

  @@index([email])
  @@index([role])
  @@index([isVerified])
  @@index([entityType])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * COMPONENT (PROCUREMENT)
 */
/**
 * --------------------------------------------------------------------------
 */
model Component {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Back relation to User (many‑to‑many)
  requestedBy User[] @relation("RequestedComponents")
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * SESSION
 */
/**
 * --------------------------------------------------------------------------
 */
model Session {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  ipAddress String?
  userAgent String?
  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?

  @@index([userId])
  @@index([expiresAt])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * ROLE PERMISSION
 */
/**
 * --------------------------------------------------------------------------
 */
model RolePermission {
  id        String               @id @default(cuid())
  role      UserRole
  resource  String
  action    RolePermissionAction
  condition Json?

  createdAt DateTime @default(now())

  @@unique([role, resource, action])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * PRODUCER DETAILS
 */
/**
 * --------------------------------------------------------------------------
 */
model ProducerDetails {
  id              String  @id @default(uuid())
  userId          String  @unique
  farmName        String?
  farmDescription String?
  certifications  String?
  user            User    @relation("ProducerDetails", fields: [userId], references: [id], onDelete: Cascade)
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * STORAGE DETAILS
 */
/**
 * --------------------------------------------------------------------------
 */
model StorageDetails {
  id                     String  @id @default(uuid())
  userId                 String  @unique
  facilityName           String?
  businessRegistrationId String?
  user                   User    @relation("StorageDetails", fields: [userId], references: [id], onDelete: Cascade)
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * TRANSPORTER DETAILS
 */
/**
 * --------------------------------------------------------------------------
 */
model TransporterDetails {
  id                         String  @id @default(uuid())
  userId                     String  @unique
  companyName                String?
  driverLicenseId            String?
  vehicleRegistrationDetails String?
  user                       User    @relation("TransporterDetails", fields: [userId], references: [id], onDelete: Cascade)
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * CATEGORY
 */
/**
 * --------------------------------------------------------------------------
 */
model Category {
  id        String     @id @default(cuid())
  name      String     @unique
  slug      String     @unique
  parentId  String?
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  Category[] @relation("CategoryHierarchy")
  createdAt DateTime   @default(now())
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * TAG
 */
/**
 * --------------------------------------------------------------------------
 */
model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())

  // Inverse of ProductTag.tag
  productTags ProductTag[]
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * PRODUCT LISTING
 */
/**
 * --------------------------------------------------------------------------
 */
model ProductListing {
  id                      String    @id @default(uuid())
  producerId              String
  title                   String
  description             String
  category                String
  subcategory             String?
  quantityAvailable       Float
  unitOfMeasure           String
  pricePerUnit            Float
  currency                String    @default("AOA")
  plannedAvailabilityDate DateTime?
  actualAvailabilityDate  DateTime?
  locationAddress         String?
  locationLatitude        Float?
  locationLongitude       Float?
  qualityCertifications   String?
  imagesUrls              Json?
  videoUrl                String?
  status                  String
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relations
  producer       User                @relation("ProducerListings", fields: [producerId], references: [id], onDelete: Cascade)
  orderItems     OrderItem[]         @relation("ProductOrderItems")
  reviews        Review[]            @relation("ProductReviews")
  inventoryMoves InventoryMovement[]
  productTags    ProductTag[]

  // Inverse relations
  certifications Certification[] @relation("ProductListingCertifications")
  promotions     Promotion[]     @relation("ProductListingPromotions")

  @@index([status, category])
  @@index([producerId])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * PRODUCT‑TAG (JOIN)
 */
/**
 * --------------------------------------------------------------------------
 */
model ProductTag {
  productListingId String
  tagId            String
  productListing   ProductListing @relation(fields: [productListingId], references: [id], onDelete: Cascade)
  tag              Tag            @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productListingId, tagId])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * INVENTORY MOVEMENT
 */
/**
 * --------------------------------------------------------------------------
 */
model InventoryMovement {
  id               String         @id @default(cuid())
  productListingId String
  productListing   ProductListing @relation(fields: [productListingId], references: [id], onDelete: Cascade)
  type             String // "ADD" | "RESERVE" | "FULFILL" | "ADJUST" | "CANCEL"
  quantity         Float
  unit             String
  reason           String?
  referenceId      String? // optional link to order/preorder/etc
  createdBy        String?
  createdAt        DateTime       @default(now())

  @@index([productListingId])
  @@index([createdAt])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * STORAGE LISTING
 */
/**
 * --------------------------------------------------------------------------
 */
model StorageListing {
  id                 String   @id @default(uuid())
  ownerId            String
  facilityName       String
  description        String
  storageType        String
  totalCapacity      Float?
  capacityUnit       String?
  availableCapacity  Float?
  amenities          Json?
  pricingStructure   String
  responsibilities   String?
  addressLine1       String
  city               String
  postalCode         String
  country            String   @default("Angola")
  latitude           Float?
  longitude          Float?
  imagesUrls         Json?
  availabilityStatus String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  owner   User     @relation("StorageListings", fields: [ownerId], references: [id], onDelete: Cascade)
  orders  Order[]  @relation("StorageOrders")
  reviews Review[] @relation("StorageReviews")

  @@index([ownerId, city])
  @@index([availabilityStatus])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * TRANSPORT LISTING
 */
/**
 * --------------------------------------------------------------------------
 */
model TransportListing {
  id                     String   @id @default(uuid())
  transporterId          String
  serviceTitle           String
  description            String?
  vehicleType            String
  carryingCapacityWeight Float?
  capacityWeightUnit     String?
  carryingCapacityVolume Float?
  capacityVolumeUnit     String?
  operationalRoutes      String?
  primaryDestinationType String?
  pricingModel           String
  baseLocationCity       String
  baseLocationCountry    String   @default("Angola")
  availabilityStatus     String
  insuranceDetails       String?
  imagesUrls             Json?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  transporter User     @relation("TransportListings", fields: [transporterId], references: [id], onDelete: Cascade)
  orders      Order[]  @relation("TransportOrders")
  reviews     Review[] @relation("TransportReviews")

  @@index([transporterId, baseLocationCity])
  @@index([availabilityStatus])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * ORDER
 */
/**
 * --------------------------------------------------------------------------
 */
model Order {
  id                    String        @id @default(uuid())
  orderNumber           String?       @unique
  buyerId               String
  sellerId              String
  transporterId         String?
  transportListingId    String?
  storageId             String?
  orderDate             DateTime      @default(now())
  totalAmount           Float
  currency              String        @default("AOA")
  orderStatus           OrderStatus   @default(PENDING)
  paymentStatus         PaymentStatus @default(PENDING)
  paymentMethod         String?
  transactionId         String?
  shippingAddressLine1  String
  shippingCity          String
  shippingPostalCode    String
  shippingCountry       String        @default("Angola")
  notesForSeller        String?
  notesForTransporter   String?
  estimatedDeliveryDate DateTime?
  actualDeliveryDate    DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  buyer            User              @relation("BuyerOrders", fields: [buyerId], references: [id], onDelete: Cascade)
  seller           User              @relation("SellerOrders", fields: [sellerId], references: [id], onDelete: Cascade)
  transporter      User?             @relation("TransporterOrders", fields: [transporterId], references: [id], onDelete: SetNull)
  transportListing TransportListing? @relation("TransportOrders", fields: [transportListingId], references: [id], onDelete: SetNull)
  storage          StorageListing?   @relation("StorageOrders", fields: [storageId], references: [id], onDelete: SetNull)

  orderItems    OrderItem[]          @relation("OrderItems")
  statusHistory OrderStatusHistory[]
  preOrder      PreOrder?
  shipment      Shipment?

  @@index([buyerId, sellerId, orderStatus])
  @@index([orderNumber])
  @@index([createdAt])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * ORDER ITEM
 */
/**
 * --------------------------------------------------------------------------
 */
model OrderItem {
  id                  String   @id @default(uuid())
  orderId             String
  productListingId    String
  quantityOrdered     Float
  pricePerUnitAtOrder Float
  subtotal            Float
  createdAt           DateTime @default(now())

  order          Order          @relation("OrderItems", fields: [orderId], references: [id], onDelete: Cascade)
  productListing ProductListing @relation("ProductOrderItems", fields: [productListingId], references: [id])

  @@index([orderId])
  @@index([productListingId])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * ORDER STATUS HISTORY
 */
/**
 * --------------------------------------------------------------------------
 */
model OrderStatusHistory {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status    String
  notes     String?  @db.Text
  changedBy String
  user      User     @relation(fields: [changedBy], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([changedBy])
  @@index([createdAt])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * SHIPMENT
 */
/**
 * --------------------------------------------------------------------------
 */
model Shipment {
  id            String  @id @default(cuid())
  orderId       String  @unique
  order         Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  transporterId String?
  transporter   User?   @relation("ShipmentTransporter", fields: [transporterId], references: [id], onDelete: SetNull)

  origin       String
  destination  String
  pickupDate   DateTime?
  deliveryDate DateTime?
  status       ShipmentStatus @default(PENDING_PICKUP)
  trackingCode String?
  notes        String?        @db.Text
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  events TrackingEvent[]

  @@index([status])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * TRACKING EVENT
 */
/**
 * --------------------------------------------------------------------------
 */
model TrackingEvent {
  id          String            @id @default(cuid())
  shipmentId  String
  shipment    Shipment          @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  eventType   TrackingEventType
  description String?           @db.Text
  location    String?
  latitude    Float?
  longitude   Float?
  occurredAt  DateTime          @default(now())

  @@index([shipmentId, occurredAt])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * REVIEW
 */
/**
 * --------------------------------------------------------------------------
 */
model Review {
  id                  String   @id @default(uuid())
  reviewerId          String
  reviewedUserId      String?
  reviewedProductId   String?
  reviewedStorageId   String?
  reviewedTransportId String?
  reviewedEntityType  String
  rating              Int
  comment             String?
  reviewDate          DateTime @default(now())
  isApprovedByAdmin   Boolean  @default(true)
  createdAt           DateTime @default(now())

  reviewer          User              @relation("ReviewerReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewedUser      User?             @relation("ReviewedUserReviews", fields: [reviewedUserId], references: [id], onDelete: SetNull)
  reviewedProduct   ProductListing?   @relation("ProductReviews", fields: [reviewedProductId], references: [id], onDelete: SetNull)
  reviewedStorage   StorageListing?   @relation("StorageReviews", fields: [reviewedStorageId], references: [id], onDelete: SetNull)
  reviewedTransport TransportListing? @relation("TransportReviews", fields: [reviewedTransportId], references: [id], onDelete: SetNull)

  @@index([reviewerId])
  @@index([reviewedEntityType, reviewedUserId, reviewedProductId, reviewedStorageId, reviewedTransportId])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * USER RATING
 */
/**
 * --------------------------------------------------------------------------
 */
model UserRating {
  id          String   @id @default(uuid())
  reviewerId  String
  reviewedId  String
  rating      Int
  comment     String?
  createdAt   DateTime @default(now())
  isModerated Boolean  @default(false)

  reviewer User @relation("Reviewer", fields: [reviewerId], references: [id])
  reviewed User @relation("Reviewed", fields: [reviewedId], references: [id])

  @@index([reviewerId, reviewedId])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * CONVERSATION
 */
/**
 * --------------------------------------------------------------------------
 */
model Conversation {
  id        String   @id @default(cuid())
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants ConversationParticipant[]
  messages     Message[]
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * CONVERSATION PARTICIPANT
 */
/**
 * --------------------------------------------------------------------------
 */
model ConversationParticipant {
  conversationId String
  userId         String
  joinedAt       DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation("ParticipantConversations", fields: [userId], references: [id], onDelete: Cascade)

  @@id([conversationId, userId])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * MESSAGE
 */
/**
 * --------------------------------------------------------------------------
 */
model Message {
  id             String    @id @default(uuid())
  conversationId String
  senderId       String
  receiverId     String
  messageContent String
  sentAt         DateTime  @default(now())
  readAt         DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SenderMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver     User         @relation("ReceiverMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId, receiverId])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * DOCUMENT
 */
/**
 * --------------------------------------------------------------------------
 */
model Document {
  id              String         @id @default(cuid())
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            String
  fileName        String
  fileUrl         String
  fileKey         String?
  fileSize        Int?
  mimeType        String?
  relatedEntityId String?
  status          DocumentStatus @default(PENDING_REVIEW)
  rejectionReason String?
  reviewedBy      String?
  reviewedAt      DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  verificationRequests VerificationRequest[]

  @@index([userId])
  @@index([type])
  @@index([status])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * VERIFICATION REQUEST
 */
/**
 * --------------------------------------------------------------------------
 */
model VerificationRequest {
  id         String             @id @default(cuid())
  documentId String
  document   Document           @relation(fields: [documentId], references: [id], onDelete: Cascade)
  assignedTo String?
  reviewer   User?              @relation("UserVerificationRequests", fields: [assignedTo], references: [id], onDelete: SetNull)
  status     VerificationStatus @default(PENDING)
  severity   SeverityLevel      @default(INFO)
  notes      String?            @db.Text
  createdAt  DateTime           @default(now())
  reviewedAt DateTime?

  @@index([documentId])
  @@index([assignedTo, status])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * NOTIFICATION
 */
/**
 * --------------------------------------------------------------------------
 */
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  title     String
  message   String   @db.Text
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deliveries NotificationDelivery[]

  @@index([userId, read])
  @@index([createdAt])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * NOTIFICATION DELIVERY
 */
/**
 * --------------------------------------------------------------------------
 */
model NotificationDelivery {
  id                String                     @id @default(cuid())
  notificationId    String
  notification      Notification               @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  channel           NotificationChannel
  status            NotificationDeliveryStatus @default(QUEUED)
  providerMessageId String?
  sentAt            DateTime?
  failedAt          DateTime?
  errorMessage      String?
  createdAt         DateTime                   @default(now())

  // Inverse side of User.notificationDeliveriesOwned
  userId String?
  user   User?   @relation("UserNotificationDeliveries", fields: [userId], references: [id], onDelete: SetNull)

  @@index([channel, status])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * PAYMENT PROVIDER
 */
/**
 * --------------------------------------------------------------------------
 */
model PaymentProvider {
  id       String  @id @default(cuid())
  name     String  @unique
  type     String
  isActive Boolean @default(true)
  config   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Inverse of PaymentTransaction.provider
  paymentTransactions PaymentTransaction[] @relation("ProviderTransactions")
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * PAYMENT TRANSACTION
 */
/**
 * --------------------------------------------------------------------------
 */
model PaymentTransaction {
  id                String        @id @default(uuid())
  buyerId           String
  sellerId          String
  amount            Decimal       @db.Decimal(18, 2)
  currency          String        @default("AOA")
  status            PaymentStatus @default(PENDING)
  type              String? // PAYMENT, REFUND, WITHDRAWAL, DEPOSIT
  buyerConfirmed    Boolean       @default(false)
  sellerConfirmed   Boolean       @default(false)
  escrowHeldAt      DateTime?
  releasedAt        DateTime?
  providerPaymentId String?
  providerChargeId  String?
  idempotencyKey    String?       @unique
  metadata          String?       @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  buyer         User                @relation("Buyer", fields: [buyerId], references: [id], onDelete: Cascade)
  seller        User                @relation("Seller", fields: [sellerId], references: [id], onDelete: Cascade)
  escrow        EscrowTransaction?  @relation("PaymentEscrow")
  ledgerEntries TransactionLedger[]
  providerId    String?
  provider      PaymentProvider?    @relation("ProviderTransactions", fields: [providerId], references: [id], onDelete: SetNull)

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([idempotencyKey])
  @@index([createdAt])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * ESCROW TRANSACTION
 */
/**
 * --------------------------------------------------------------------------
 */
model EscrowTransaction {
  id                   String             @id @default(cuid())
  paymentTransactionId String             @unique
  paymentTransaction   PaymentTransaction @relation("PaymentEscrow", fields: [paymentTransactionId], references: [id])
  milestone            String?
  status               EscrowStatus       @default(HELD)
  releaseDate          DateTime?
  releasedBy           String?
  createdAt            DateTime           @default(now())

  @@index([paymentTransactionId])
  @@index([status])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * TRANSACTION LEDGER
 */
/**
 * --------------------------------------------------------------------------
 */
model TransactionLedger {
  id            String             @id @default(cuid())
  transactionId String
  transaction   PaymentTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  userId        String
  user          User               @relation(fields: [userId], references: [id])
  accountType   String // WALLET, ESCROW, REVENUE
  entryType     String // DEBIT, CREDIT
  amount        Float
  balance       Float
  description   String
  createdAt     DateTime           @default(now())

  @@index([transactionId])
  @@index([userId])
  @@index([createdAt])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * PAYMENT REFERENCE
 */
/**
 * --------------------------------------------------------------------------
 */
model PaymentReference {
  id          String        @id @default(cuid())
  reference   String        @unique
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  operationId String?
  amount      Float
  status      PaymentStatus @default(PENDING)
  confirmedAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt // <-- fixed duplicate

  @@index([reference])
  @@index([userId])
  @@index([status])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * WALLET BALANCE
 */
/**
 * --------------------------------------------------------------------------
 */
model WalletBalance {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  balance   Decimal  @default("0") @db.Decimal(18, 2)
  updatedAt DateTime @updatedAt

  @@index([userId])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * TRANSFORMATION FACILITY
 */
/**
 * --------------------------------------------------------------------------
 */
model TransformationFacility {
  id             String            @id @default(cuid())
  name           String
  location       String
  serviceType    String
  capacity       Float
  processingRate Float             @default(0)
  isActive       Boolean           @default(true)
  ownerId        String
  owner          User              @relation("OwnerFacilities", fields: [ownerId], references: [id], onDelete: Cascade)
  bookings       FacilityBooking[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([ownerId])
  @@index([isActive])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * FACILITY BOOKING
 */
/**
 * --------------------------------------------------------------------------
 */
model FacilityBooking {
  id              String                 @id @default(cuid())
  facilityId      String
  facility        TransformationFacility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  userId          String
  user            User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceType     String
  startDate       DateTime
  endDate         DateTime
  actualStartDate DateTime?
  actualEndDate   DateTime?
  quantity        Float                  @default(0)
  inputProduct    String
  desiredOutput   String
  notes           String?                @db.Text
  status          BookingStatus          @default(PENDING)
  totalCost       Float
  currency        String                 @default("AOA")
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  @@index([facilityId])
  @@index([userId])
  @@index([status])
  @@index([startDate, endDate])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * PRODUCTION PLAN
 */
/**
 * --------------------------------------------------------------------------
 */
model ProductionPlan {
  id                   String           @id @default(cuid())
  producerId           String
  producer             User             @relation("ProductionPlans", fields: [producerId], references: [id], onDelete: Cascade)
  productName          String
  productCategory      String
  variety              String?
  areaSize             Float
  areaUnit             String           @default("HECTARES")
  location             String
  coordinates          String?
  estimatedQuantity    Float
  quantityUnit         String
  estimatedYield       Float?
  plantingDate         DateTime
  estimatedHarvestDate DateTime
  actualHarvestDate    DateTime?
  status               ProductionStatus @default(PLANNED)
  isPublic             Boolean          @default(true)
  allowPreOrders       Boolean          @default(false)
  description          String?          @db.Text
  farmingMethod        String?
  certifications       String[]
  images               String[]
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  schedules   ProductionSchedule[]
  updates     ProductionUpdate[]
  subscribers ProductionSubscriber[]
  preOrders   PreOrder[]

  @@index([producerId])
  @@index([status])
  @@index([estimatedHarvestDate])
  @@index([isPublic])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * PRODUCTION SCHEDULE
 */
/**
 * --------------------------------------------------------------------------
 */
model ProductionSchedule {
  id               String         @id @default(cuid())
  productionPlanId String
  productionPlan   ProductionPlan @relation(fields: [productionPlanId], references: [id], onDelete: Cascade)
  milestoneName    String
  milestoneType    MilestoneType
  description      String?        @db.Text
  scheduledDate    DateTime
  completedDate    DateTime?
  status           ScheduleStatus @default(PENDING)
  notifyBefore     Int            @default(0)
  notificationSent Boolean        @default(false)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@index([productionPlanId])
  @@index([scheduledDate])
  @@index([status])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * PRODUCTION UPDATE
 */
/**
 * --------------------------------------------------------------------------
 */
model ProductionUpdate {
  id                 String         @id @default(cuid())
  productionPlanId   String
  productionPlan     ProductionPlan @relation(fields: [productionPlanId], references: [id], onDelete: Cascade)
  updateType         UpdateType
  title              String
  description        String         @db.Text
  images             String[]
  currentGrowthStage String?
  healthStatus       String?
  quantityAdjustment Float?
  dateAdjustment     DateTime?
  createdBy          String
  user               User           @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt          DateTime       @default(now())

  @@index([productionPlanId])
  @@index([createdAt])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * PRODUCTION SUBSCRIBER
 */
/**
 * --------------------------------------------------------------------------
 */
model ProductionSubscriber {
  id                 String         @id @default(cuid())
  productionPlanId   String
  productionPlan     ProductionPlan @relation(fields: [productionPlanId], references: [id], onDelete: Cascade)
  userId             String
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifyOnUpdate     Boolean        @default(true)
  notifyOnMilestone  Boolean        @default(true)
  notify15DaysBefore Boolean        @default(true)
  notify7DaysBefore  Boolean        @default(true)
  notify1DayBefore   Boolean        @default(true)
  notifyOnHarvest    Boolean        @default(true)
  subscribedAt       DateTime       @default(now())

  @@unique([productionPlanId, userId])
  @@index([userId])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * PRE‑ORDER
 */
/**
 * --------------------------------------------------------------------------
 */
model PreOrder {
  id                 String         @id @default(cuid())
  productionPlanId   String
  productionPlan     ProductionPlan @relation(fields: [productionPlanId], references: [id], onDelete: Cascade)
  customerId         String
  customer           User           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  quantity           Float
  pricePerUnit       Float?
  totalPrice         Float?
  status             PreOrderStatus @default(PENDING)
  depositAmount      Float?
  depositPaid        Boolean        @default(false)
  notes              String?        @db.Text
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @default(now()) @updatedAt
  convertedToOrderId String?        @unique
  convertedToOrder   Order?         @relation(fields: [convertedToOrderId], references: [id])

  @@index([productionPlanId])
  @@index([customerId])
  @@index([status])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * OFFERING
 */
/**
 * --------------------------------------------------------------------------
 */
model Offering {
  id          String             @id @default(cuid())
  title       String
  description String?
  ownerId     String
  owner       User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  schedules   OfferingSchedule[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([ownerId])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * OFFERING SCHEDULE
 */
/**
 * --------------------------------------------------------------------------
 */
model OfferingSchedule {
  id         String        @id @default(cuid())
  offeringId String
  offering   Offering      @relation(fields: [offeringId], references: [id], onDelete: Cascade)
  startTime  DateTime
  endTime    DateTime
  bookedById String?
  bookedBy   User?         @relation(fields: [bookedById], references: [id], onDelete: SetNull)
  status     BookingStatus @default(PENDING)
  notes      String?       @db.Text
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@index([offeringId])
  @@index([startTime, endTime])
  @@index([bookedById])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * CERTIFICATION
 */
/**
 * --------------------------------------------------------------------------
 */
model Certification {
  id               String          @id @default(cuid())
  userId           String?
  user             User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  productListingId String?
  productListing   ProductListing? @relation("ProductListingCertifications", fields: [productListingId], references: [id], onDelete: SetNull)
  name             String // e.g., "Organic", "FairTrade"
  issuer           String
  certificateId    String
  issueDate        DateTime
  expiryDate       DateTime?
  verified         Boolean         @default(false)
  createdAt        DateTime        @default(now())

  @@index([userId, productListingId])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * PROMOTION
 */
/**
 * --------------------------------------------------------------------------
 */
model Promotion {
  id                 String          @id @default(cuid())
  title              String
  description        String?
  type               PromotionType
  value              Float // percentage or fixed amount depending on type
  startDate          DateTime
  endDate            DateTime?
  active             Boolean         @default(true)
  appliesToListingId String?
  listing            ProductListing? @relation("ProductListingPromotions", fields: [appliesToListingId], references: [id], onDelete: SetNull)
  appliesToCategory  String? // optional category‑wide promotion
  createdAt          DateTime        @default(now())

  @@index([active, startDate, endDate])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * AUDIT LOG
 */
/**
 * --------------------------------------------------------------------------
 */
model AuditLog {
  id             String        @id @default(cuid())
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  action         String
  entityType     String
  entityId       String
  severity       SeverityLevel @default(INFO)
  details        Json?
  entitySnapshot Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime      @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
}

/**
 * --------------------------------------------------------------------------
 */
/**
 * METRIC SNAPSHOT
 */
/**
 * --------------------------------------------------------------------------
 */
model MetricSnapshot {
  id         String   @id @default(cuid())
  key        String // e.g., "daily_sales_AOA", "avg_delivery_days", "new_users"
  scope      String? // global, user:<id>, category:<name>
  value      Float
  capturedAt DateTime @default(now())
  metadata   Json?

  @@index([key, capturedAt])
}
